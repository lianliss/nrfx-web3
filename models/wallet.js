const logger = require('../utils/logger');
const _ = require('lodash');
const db = require('./db');
const web3Service = require('../services/web3');
const tonService = require('../services/ton');
const errors = require('./error');

class Wallet {
    constructor(data) {
        this.data = data;

        if (!this.service) {
            this.service = this.getService(data.network);
        }
    }
    data = {};

    /**
     * Save this wallet to data base
     */
    save = async () => db.setUserWallet(this.data);

    /**
     * Get right network service
     * @param network
     * @returns {*}
     */
    getService = network => {
        let service;
        switch (network) {
            case 'TON':
                service = tonService;
                break;
            case 'BEP20':
            default:
                service = web3Service;
        }
        return service;
    };

    /**
     * Create a new wallet in BEP20 network and save it to user
     * @param userID
     * @param network
     * @returns {Promise.<*>} - will return a new wallet
     */
    static create = async (userID, network = 'BEP20') => {
        try {
            const service = this.getService(network);
            const account = await service.createAccount();
            const key = account.mnemonic || account.privateKey;
            const data = {
                userID,
                address: account.address,
                encryption: service.encrypt(key, userID),
                isGenerated: true,
                network,
                service,
            };
            const wallet = new Wallet(data);
            await wallet.save();
            return wallet;
        } catch (error) {
            logger.error('[Wallet][create]', error);
        }
    };

    /**
     * Import address as wallet. User can only receive tokens to this wallet
     * @param userID {int}
     * @param address {string} - wallet address
     * @param network {string} - wallet network (optional) Default: 'BEP20'
     * @returns {Promise.<Wallet>} - new wallet
     */
    static importAddress = async (userID, address, network = 'BEP20') => {
        const wallet = new Wallet({
            userID, address, network,
        });
        await wallet.save();
        return wallet;
    };

    /**
     * Import wallet with full functionality as generated by our service
     * @param userID
     * @param key
     * @param network {string} - wallet network (optional) Default: 'BEP20'
     * @returns {Promise.<*>}
     */
    static importPrivateKey = async (userID, key, network = 'BEP20') => {
        try {
            const service = this.getService(network);
            const account = await service.getAccount(key);
            const data = {
                userID,
                address: account.address,
                privateData: service.encrypt(key, userID),
                isGenerated: true,
                network,
                service,
            };
            const wallet = new Wallet(data);
            await wallet.save();
            return wallet;
        } catch (error) {
            logger.error('[Wallet][importPrivateKey]', error);
            return;
        }
    };

    /**
     * Returns current wallet private key if it exits
     * @returns {*}
     */
    getPrivateKey = () => {
        const {userID, service} = this.data;

        const key = this.data.encryption || this.data.privateData;
        if (!userID || !key) return false;

        const account = service.decrypt(key, userID);
        if (account && (account.privateKey || account.mnemonic)) {
            return account.privateKey || account.mnemonic;
        } else {
            return false;
        }
    };

    /**
     * Returns wallet balances
     * @returns {Promise.<*>}
     */
    getBalances = async () => {
        try {
            const {service, address} = this.data;

            return await service.getBalances(address);
        } catch (error) {
            logger.error('[Wallet][getBalances]', network, error);
            return {};
        }
    };

    /**
     * Returns this wallet account if this wallet is generated by us
     */
    getAccount = async () => {
        const key = this.getPrivateKey();
        if (!key) throw new errors.NotNarfexWalletError();
        return await this.service.getAccount(key);
    };

    /**
     * Transfer token to another wallet
     * @param recipient {string} - receiver wallet address
     * @param token {string} - token symbol
     * @param amount {number} - amount of tokens
     * @returns {Promise.<void>}
     */
    transfer = async (recipient, token, amount) => {
        try {
            const account = await this.getAccount();
            await this.service.transfer(recipient, token, amount, undefined, account);
        } catch (error) {
            logger.error('[Wallet][transfer]', this.data.userID, this.data.network, token, amount, error);
            throw error;
        }
    };
}

module.exports = Wallet;
